# Flaw Nozzle Finder (Python) - 计算流程说明

## 输入
- CSV 文件，表头包含 `Label`, `X`, `Y`（大小写容忍；也兼容 `X,`/`Y,` 字段）。每行一个坐标点，通过 `Label` 区分图片。
- 运行参数：
  - `-m/--machine` 机器号后缀（必填），用于输出文件名。
  - `--nozzles` 喷头总数，默认 636。
  - `--tolerance` 容忍度（单位：步长），默认 0.25。

## 处理步骤
1) **按 Label 分组**
   - 顺序读取 CSV 行，空 Label 的行跳过。
   - 将 `(X, Y)` 追加到对应 `label` 的列表。

2) **旋转校正（逐 Label）**
   - 若该 label 点数 < 2，跳过（不会产生喷头编号）。
   - 将点按 X 升序排序，取首点 `(x1, y1)` 与末点 `(x2, y2)`。
   - 方向向量 `(dx, dy) = (x2 - x1, y2 - y1)`，角度 `angle = atan2(dy, dx)`（仅校正小倾斜，避免 90° 交换 XY）。
   - 用 `-angle` 旋转所有点（使轨迹趋于竖直）：
     - `rx = x*cos(-angle) - y*sin(-angle)`
     - `ry = x*sin(-angle) + y*cos(-angle)`
   - 后续只使用旋后的 X 坐标。

3) **喷头序号推算（逐 Label）**
   - 输入：旋后 X 序列 `xs`，喷头总数 `N`，容忍度 `tol`。
   - 若 `xs` 少于 2 个，跳过。
   - `start = min(xs)`，`end = max(xs)`，`mid = xs` 去除首尾。
   - 步长 `step = (end - start) / (N - 1)`。
   - 对每个中间点 `x`：
     - 理论位置 `pos = (x - start) / step + 1`
     - 取 `rounded = round(pos)`
     - 若 `abs(rounded - pos) < tol`，接受 `rounded` 为喷头编号；否则判定为 out-of-range（仅提示，不写入结果）。

4) **合并与输出**
- 收集全部 label 的喷头编号，去重并排序。
- 写入 `flaw_nozzle_<YYYYMMDD>_680k_<机器号>.txt`（与输入 CSV 同目录），每行一个编号。
- 控制台打印调试信息：每个 label 的点数、编号列表、out-of-range（显示 pos 值），以及合并编号。

## 调试信息（stdout）
- 汇总：总 label 数、总点数、合并后喷头编号列表。
- 每个 Label：点数、计算出的喷头编号列表、是否存在 out-of-range（及数量）。

## GUI 导入
- 若命令行未提供 CSV 路径，会弹出文件选择对话框（tkinter）。否则使用命令行路径。
- 运行流程为逐步交互：显示已选文件 → 回车继续加载 → 显示标签与数量 → 回车计算 → 显示调试信息 → 回车导出。若命令行未给 machine 编号，会在导出前提示输入。

## 示例（20251122六号机680KResults.csv，`-m 04`）
- A.tif: 2 点 → 无中间点 → 无编号
- ACT.tif: 4 点 → 编号 [411, 585]
- C.tif: 2 点 → 无编号
- G.tif: 3 点 → 编号 [424]
- T.tif: 7 点 → 编号 [288, 479, 610]，out-of-range 2 个（pos≈426.436, 462.411）
- 合并编号: [288, 411, 424, 479, 585, 610]
- 输出文件: `flaw_nozzle_20251203_680k_04.txt`
- 控制台会警告存在 out-of-range。

## 常见误差来源
- 首尾点并非真实首末喷头，导致步长估计偏差。
- 中间点很少或缺失，无法给出编号。
- 轨迹不是单调 X 方向，旋转后 X 间距不均匀。
- 容忍度 `tol` 太小/太大，或实际喷头总数不是 636。
- CSV 含空行或异常坐标无法解析。
